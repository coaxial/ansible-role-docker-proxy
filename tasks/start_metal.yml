---
- name: Get docker bridge network gateway
  command: "{% raw -%}docker network inspect bridge --format '{{range .IPAM.Config}}{{.Gateway}}{{end}}'{% endraw -%}"
  changed_when: false
  register: _dp__docker_gw_ip

- name: Create directory for nginx config files if needed
  # will only create the dir if there is a non-containerized upstream service
  # defined
  file:
    path: "{{ dp__nginx_config_dir }}"
    state: directory
  when: dp__upstream |selectattr("is_container", "equalto", true)

- name: Copy nginx config file
  include: copy_nginx_conf.yml
  with_items: "{{ dp__upstream }}"
  loop_control:
    loop_var: upstream

- name: Configure basic auth
  htpasswd:
    path: "{{ dp__nginx_config_dir }}/{{ item.svc_name }}.htpasswd"
    user: "{{ item.bauth_user }}"
    password: "{{ item.bauth_passwd }}"
  with_items: "{{ dp__upstream}}"
  when: item.bauth_enable is defined and item.bauth_enable and not item.is_container

- name: Compose envfile
  template:
    src: nginx-envfile.j2
    dest: "{{ dp__nginx_config_dir }}/{{ item.svc_name }}.envfile"
  with_items: "{{ dp__upstream }}"

- name: Compose volumes
  template:
    src: nginx-volumes.j2
    dest: "{{ dp__nginx_config_dir }}/{{ item.svc_name }}.envfile"
  with_items: "{{ dp__upstream }}"

- name: Proxy non-docker webservers
  docker_container:
    image: nginx
    name: "nginx-{{ item.svc_name }}"
    env_file: "{{ dp__nginx_config_dir }}/{{ item.svc_name }}"
    networks:
      - name: "{{ dp__network_name }}"
    # volumes are in a file because htpasswd is optional
    volumes: "{{ lookup('file', dp__nginx_config_dir+'/'+item.svc_name+'.htpasswd') }}"
    restart_policy: always
  with_items: "{{ dp__upstream }}"
  loop_control:
    label: "{{ item.svc_name }}"
  when: not item.is_container
